steps:
  # Test 1: Elastic CI Stack
  - label: "‚òÅÔ∏è Elastic CI Stack - Deploy"
    key: "elastic-deploy"
    agents:
      queue: default
    command: |
      # Configure kubectl for EKS cluster using IAM role authentication
      aws eks update-kubeconfig --region us-east-1 --name ola-bk-test
    plugins:
      - https://github.com/mykematt/deployment-helm-chart-buildkite-plugin.git#main:
          mode: deploy
          release: elastic-helm-test
          chart: oci://registry-1.docker.io/bitnamicharts/nginx
          namespace: elastic-test
          set:
            - service.type=ClusterIP
          timeout: 100s
          wait: true
          atomic: true
          create_namespace: true

  # Test 2: Kubernetes Agent
  - label: "üöÄ Kubernetes Agent - Deploy"
    key: "k8s-deploy"
    agents:
      queue: kubernetes
    plugins:
      - kubernetes:
          podSpecPatch:
            containers:
            - name: container-0
              image: dtzar/helm-kubectl:latest
            serviceAccountName: deployer-manager
      - https://github.com/mykematt/deployment-helm-chart-buildkite-plugin.git#main:
          mode: deploy
          release: k8s-helm-test
          chart: oci://registry-1.docker.io/bitnamicharts/nginx
          namespace: k8s-test
          set:
            - service.type=ClusterIP
          timeout: 100s
          wait: true
          atomic: true
          create_namespace: true

  # Test 3: Mac Agent
  - env:
      KUBECONFIG: "./.kube/config"
    key: "mac-deploy"
    label: "üçé Mac Agent - Deploy"
    agents:
      queue: mac
    command: |
      # Configure kubectl for EKS cluster using AWS credentials
      aws eks update-kubeconfig --region us-east-1 --name ola-bk-test
    plugins:
      - https://github.com/mykematt/deployment-helm-chart-buildkite-plugin.git#main:
          mode: deploy
          release: mac-helm-test
          chart: oci://registry-1.docker.io/bitnamicharts/nginx
          namespace: mac-test
          set:
            - service.type=ClusterIP
          timeout: 100s
          wait: true
          atomic: true
          create_namespace: true

  # Test 4: Linux Agent
  - env:
      KUBECONFIG: "/mnt/mac/Users/olabuildkite/.kube/config"
    key: "linux-deploy"
    label: "üêß Linux Agent - Deploy"
    agents:
      queue: linux
    command: |
      # Configure kubectl for EKS cluster using AWS credentials
      aws eks update-kubeconfig --region us-east-1 --name ola-bk-test
    plugins:
      - https://github.com/mykematt/deployment-helm-chart-buildkite-plugin.git#main:
          mode: deploy
          release: linux-helm-test
          chart: oci://registry-1.docker.io/bitnamicharts/nginx
          namespace: linux-test
          set:
            - service.type=ClusterIP
          timeout: 100s
          wait: true
          atomic: true
          create_namespace: true

  # Verification: Check All Deployments Are Running
  - label: "‚úÖ Verify All Deployments Running"
    key: "verify-deployments"
    depends_on: 
      - "elastic-deploy"
      - "k8s-deploy"
      - "mac-deploy"
      - "linux-deploy"
    agents:
      queue: kubernetes
    plugins:
      - kubernetes:
          podSpecPatch:
            containers:
            - name: container-0
              image: dtzar/helm-kubectl:latest
            serviceAccountName: deployer-manager
    command: |
      echo "üîç Verifying all deployments are running..."
      
      # Check each deployment status
      deployments=(
        "elastic-helm-test:elastic-test"
        "k8s-helm-test:k8s-test"
        "mac-helm-test:mac-test"
        "linux-helm-test:linux-test"
      )
      
      for deployment in "${deployments[@]}"; do
        IFS=':' read -r release namespace <<< "$deployment"
        echo "üìã Checking $release in namespace $namespace..."
        
        # Check Helm release status
        helm status "$release" -n "$namespace"
        
        # Wait for deployment to be ready
        kubectl wait --for=condition=available deployment -l app.kubernetes.io/instance="$release" -n "$namespace" --timeout=120s
        
        # Get pod status
        kubectl get pods -n "$namespace" -l app.kubernetes.io/instance="$release"
      done
      
      echo "‚úÖ All deployments verified as running!"

  # Test 5: Rollback Elastic CI Stack Deployment
  - label: "üîÑ Rollback Elastic CI Stack"
    key: "rollback-elastic"
    depends_on: "verify-deployments"
    agents:
      queue: default
    command: |
      # Configure kubectl for EKS cluster using IAM role authentication
      aws eks update-kubeconfig --region us-east-1 --name ola-bk-test
      echo "üîÑ Testing plugin rollback for Elastic CI Stack deployment..."
    plugins:
      - https://github.com/mykematt/deployment-helm-chart-buildkite-plugin.git#main:
          mode: rollback
          release: elastic-helm-test
          namespace: elastic-test

  # Test 6: Rollback Kubernetes Agent Deployment  
  - label: "üîÑ Rollback Kubernetes Agent"
    key: "rollback-k8s"
    depends_on: "verify-deployments"
    agents:
      queue: kubernetes
    plugins:
      - kubernetes:
          podSpecPatch:
            containers:
            - name: container-0
              image: dtzar/helm-kubectl:latest
            serviceAccountName: deployer-manager
      - https://github.com/mykematt/deployment-helm-chart-buildkite-plugin.git#main:
          mode: rollback
          release: k8s-helm-test
          namespace: k8s-test
    command: |
      echo "üîÑ Testing plugin rollback for Kubernetes agent deployment..."

  # Test 7: Rollback Mac Agent Deployment
  - label: "üîÑ Rollback Mac Agent"
    key: "rollback-mac"
    depends_on: "verify-deployments"
    env:
      KUBECONFIG: "./.kube/config"
    agents:
      queue: mac
    command: |
      # Configure kubectl for EKS cluster using AWS credentials
      aws eks update-kubeconfig --region us-east-1 --name ola-bk-test
      echo "üîÑ Testing plugin rollback for Mac agent deployment..."
    plugins:
      - https://github.com/mykematt/deployment-helm-chart-buildkite-plugin.git#main:
          mode: rollback
          release: mac-helm-test
          namespace: mac-test

  # Test 8: Rollback Linux Agent Deployment
  - label: "üîÑ Rollback Linux Agent"
    key: "rollback-linux"
    depends_on: "verify-deployments"
    env:
      KUBECONFIG: "/mnt/mac/Users/olabuildkite/.kube/config"
    agents:
      queue: linux
    command: |
      # Configure kubectl for EKS cluster using AWS credentials
      aws eks update-kubeconfig --region us-east-1 --name ola-bk-test
      echo "üîÑ Testing plugin rollback for Linux agent deployment..."
    plugins:
      - https://github.com/mykematt/deployment-helm-chart-buildkite-plugin.git#main:
          mode: rollback
          release: linux-helm-test
          namespace: linux-test

  # Verification Step
  - label: "‚úÖ Verify All Deployments"
    key: "verify-all"
    depends_on:
      - "rollback-elastic"
      - "rollback-k8s"
      - "rollback-mac"
      - "rollback-linux"
    agents:
      queue: "default"
    command: |
      # Configure kubectl for EKS
      aws eks update-kubeconfig --region us-east-1 --name ola-bk-test
      
      echo "üîç Verifying all deployments after rollback..."
      
      # Check all namespaces and deployments
      for namespace in elastic-test k8s-test mac-test linux-test; do
        echo "Checking namespace: $namespace"
        helm list -n $namespace || echo "No releases in $namespace"
        kubectl get pods -n $namespace || echo "No pods in $namespace"
        echo "---"
      done
      
      echo "‚úÖ Verification complete!"

  # Cleanup Step
  - label: "üßπ Cleanup All Test Deployments"
    key: "cleanup-all"
    depends_on: "verify-all"
    agents:
      queue: "default"
    command: |
      # Configure kubectl for EKS
      aws eks update-kubeconfig --region us-east-1 --name ola-bk-test
      
      echo "üßπ Cleaning up all test deployments..."
      
      # Cleanup all test releases
      helm uninstall elastic-helm-test -n elastic-test || echo "elastic-helm-test already removed"
      helm uninstall k8s-helm-test -n k8s-test || echo "k8s-helm-test already removed"
      helm uninstall mac-helm-test -n mac-test || echo "mac-helm-test already removed"
      helm uninstall linux-helm-test -n linux-test || echo "linux-helm-test already removed"
      
      # Delete namespaces
      kubectl delete namespace elastic-test || echo "elastic-test namespace already removed"
      kubectl delete namespace k8s-test || echo "k8s-test namespace already removed"
      kubectl delete namespace mac-test || echo "mac-test namespace already removed"
      kubectl delete namespace linux-test || echo "linux-test namespace already removed"
      
      echo "‚úÖ Cleanup complete!"
      echo "üéØ Multi-agent Helm plugin testing completed successfully!"
