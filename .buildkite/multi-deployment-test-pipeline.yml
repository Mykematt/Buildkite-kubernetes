steps:
  # Test 1: Elastic CI Stack Agent (Native EC2 with EKS access) - Pre-installed tools
  - label: "🚀 Deploy with Elastic CI Stack (Pre-installed Helm)"
    key: "elastic-ci-test"
    agents:
      queue: "default"
    command: |
      # Configure kubectl for EKS cluster using IAM role authentication
      aws eks update-kubeconfig --region us-east-1 --name ola-bk-test
      
      # Verify pre-installed tools are available
      echo "✅ Verifying pre-installed tools..."
      helm version
      kubectl version --client
      kubectl get nodes
      
      # Deploy using pre-installed Helm
      helm upgrade --install test-elastic-native oci://registry-1.docker.io/bitnamicharts/nginx \
        --namespace plugin \
        --create-namespace \
        --set service.type=ClusterIP \
        --timeout 100s \
        --wait \
        --atomic
      
      # Verify deployment
      kubectl get pods -n plugin -l app.kubernetes.io/name=nginx
      kubectl get svc -n plugin test-elastic-native-nginx

  # Test 2: Docker Plugin + Deployment Plugin
  - label: "🐳 Docker Plugin + Deployment Plugin"
    key: "docker-plugin-test"
    depends_on: "elastic-ci-test"
    agents:
      queue: "default"
    plugins:
      - docker#v5.11.0:
          image: "097340723131.dkr.ecr.us-east-1.amazonaws.com/buildkite-multi-tool:latest"
          propagate-environment: true
          command:
            - "/bin/bash"
            - "-c"
            - |
              # Verify all tools are available (no installation needed)
              aws --version
              kubectl version --client
              helm version
              
              # Configure kubectl for EKS
              aws eks update-kubeconfig --region us-east-1 --name ola-bk-test
              
              # Deploy using deployment plugin
              echo "Docker plugin deployment completed"
      - https://github.com/mykematt/deployment-helm-chart-buildkite-plugin.git#main:
          mode: deploy
          chart: "oci://registry-1.docker.io/bitnamicharts/nginx"
          release: "docker-plugin-nginx"
          namespace: plugin
          set:
            - service.type=ClusterIP
          timeout: "100s"
          wait: true
          atomic: true
          create_namespace: true

  # Test 3: Docker Compose Plugin + Deployment Plugin
  - label: "🐙 Docker Compose Plugin + Deployment Plugin"
    key: "docker-compose-test"
    depends_on: "docker-plugin-test"
    agents:
      queue: "default"
    plugins:
      - docker-compose#v4.16.0:
          config: docker-compose.yml
          run: helm-deployer
          propagate-environment: true
      - https://github.com/mykematt/deployment-helm-chart-buildkite-plugin.git#main:
          mode: deploy
          chart: "oci://registry-1.docker.io/bitnamicharts/nginx"
          release: "compose-plugin-nginx"
          namespace: plugin
          set:
            - service.type=ClusterIP
          timeout: "100s"
          wait: true
          atomic: true
          create_namespace: true

  # Verification Step
  - label: "✅ Verify All Deployments"
    key: "verify-all"
    depends_on: "docker-compose-test"
    agents:
      queue: kubernetes
    plugins:
      - kubernetes:
          podSpec:
            serviceAccountName: deployer-manager
            containers:
            - image: dtzar/helm-kubectl:latest
              name: helm-kubectl
    command: |
      echo "🔍 Verifying all deployments..."
      helm list -n plugin
      echo ""
      echo "📊 Deployment Status:"
      kubectl get deployments -n plugin
      echo ""
      echo "🎯 All 3 deployment methods tested successfully!"

  # Cleanup Block
  - block: "🧹 Clean up test deployments?"
    key: "cleanup-block"
    depends_on: "verify-all"

  # Cleanup Step
  - label: "🧹 Cleanup All Test Deployments"
    key: "cleanup-all"
    depends_on: "cleanup-block"
    agents:
      queue: kubernetes
    plugins:
      - kubernetes:
          podSpec:
            serviceAccountName: deployer-manager
            containers:
            - image: dtzar/helm-kubectl:latest
              name: helm-kubectl
    command: |
      echo "🧹 Cleaning up test deployments..."
      helm uninstall test-elastic-native -n plugin || true
      helm uninstall docker-plugin-nginx -n plugin || true
      helm uninstall compose-plugin-nginx -n plugin || true
      echo "✅ Cleanup complete!"
