steps:
  # Test: Native Agent (Mac local agent with kubectl/helm)
  - label: "⚡ Native Agent + Helm Chart Test"
    key: "native-agent-test"
    agents:
      queue: "mac"  # Uses local Mac agent with kubectl/helm in PATH
    env:
      KUBECONFIG: "./.kube/config"
    plugins:
      - https://github.com/mykematt/deployment-helm-chart-buildkite-plugin.git#main:
          mode: deploy
          chart: "oci://registry-1.docker.io/bitnamicharts/busybox"
          release: "native-agent-busybox"
          namespace: plugin
          set:
            - service.type=ClusterIP
          timeout: "100s"
          wait: true
          atomic: true
          create_namespace: true

  # Verification Step
  - label: "✅ Verify Native Agent Deployment"
    key: "verify-deployment"
    depends_on: "native-agent-test"
    agents:
      queue: kubernetes
    plugins:
      - kubernetes:
          podSpec:
            serviceAccountName: deployer-manager
            containers:
            - image: dtzar/helm-kubectl:latest
              name: helm-kubectl
    command: |
      echo "🔍 Verifying native agent deployment..."
      helm list -n plugin
      echo ""
      echo "📊 Deployment Status:"
      kubectl get deployments -n plugin
      echo ""
      echo "🎯 Native agent deployment test successful!"

  # Cleanup Block
  - block: "🧹 Clean up test deployments?"
    key: "cleanup-block"
    depends_on: "verify-deployment"

  # Cleanup Step
  - label: "🧹 Cleanup All Test Deployments"
    key: "cleanup-all"
    depends_on: "cleanup-block"
    agents:
      queue: kubernetes
    plugins:
      - kubernetes:
          podSpec:
            serviceAccountName: deployer-manager
            containers:
            - image: dtzar/helm-kubectl:latest
              name: helm-kubectl
    command: |
      echo "🧹 Cleaning up test deployment..."
      helm uninstall native-agent-busybox -n plugin || true
      echo "✅ Cleanup complete!"
