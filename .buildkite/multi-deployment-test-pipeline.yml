steps:
  # Test 1: Kubernetes Plugin (Current Working Method)
  - label: "ğŸš€ Test 1: Kubernetes Plugin + Helm Chart"
    key: "k8s-plugin-test"
    agents:
      queue: kubernetes
    plugins:
      - kubernetes:
          podSpec:
            serviceAccountName: deployer-manager
            containers:
            - image: dtzar/helm-kubectl:latest
              name: helm-kubectl
      - https://github.com/mykematt/deployment-helm-chart-buildkite-plugin.git#main:
          mode: deploy
          chart: "oci://registry-1.docker.io/bitnamicharts/nginx"
          release: "k8s-plugin-nginx"
          namespace: plugin
          set:
            - service.type=ClusterIP
          timeout: "100s"
          wait: true
          atomic: true
          create_namespace: true

  # Test 2: Docker Plugin Approach
  - label: "ğŸ³ Test 2: Docker Plugin + Helm Chart"
    key: "docker-plugin-test"
    depends_on: "k8s-plugin-test"
    plugins:
      - docker#v5.8.0:
          image: "dtzar/helm-kubectl:latest"
          environment:
            - KUBECONFIG=/workspace/.kube/config
          volumes:
            - "./.kube:/workspace/.kube:ro"
          propagate-environment: true
      - https://github.com/mykematt/deployment-helm-chart-buildkite-plugin.git#main:
          mode: deploy
          chart: "oci://registry-1.docker.io/bitnamicharts/apache"
          release: "docker-plugin-apache"
          namespace: plugin
          set:
            - service.type=ClusterIP
          timeout: "100s"
          wait: true
          atomic: true
          create_namespace: true

  # Test 3: Docker Compose Plugin Approach
  - label: "ğŸ™ Test 3: Docker Compose Plugin + Helm Chart"
    key: "docker-compose-test"
    depends_on: "docker-plugin-test"
    plugins:
      - docker-compose#v4.16.0:
          run: helm-deployer
          propagate-environment: true
      - https://github.com/mykematt/deployment-helm-chart-buildkite-plugin.git#main:
          mode: deploy
          chart: "oci://registry-1.docker.io/bitnamicharts/nginx"
          release: "compose-plugin-nginx"
          namespace: plugin
          set:
            - service.type=ClusterIP
          timeout: "100s"
          wait: true
          atomic: true
          create_namespace: true

  # Test 4: Native Agent (Mac local agent with kubectl/helm)
  - label: "âš¡ Test 4: Native Agent + Helm Chart"
    key: "native-agent-test"
    depends_on: "docker-compose-test"
    agents:
      queue: "mac"  # Uses local Mac agent with kubectl/helm in PATH
    env:
      KUBECONFIG: "./.kube/config"
    plugins:
      - https://github.com/mykematt/deployment-helm-chart-buildkite-plugin.git#main:
          mode: deploy
          chart: "oci://registry-1.docker.io/bitnamicharts/busybox"
          release: "native-agent-busybox"
          namespace: plugin
          set:
            - service.type=ClusterIP
          timeout: "100s"
          wait: true
          atomic: true
          create_namespace: true

  # Verification Step
  - label: "âœ… Verify All Deployiments"
    key: "verify-all"
    depends_on: "native-agent-test"
    agents:
      queue: kubernetes
    plugins:
      - kubernetes:
          podSpec:
            serviceAccountName: deployer-manager
            containers:
            - image: dtzar/helm-kubectl:latest
              name: helm-kubectl
    command: |
      echo "ğŸ” Verifying all deployments..."
      helm list -n plugin
      echo ""
      echo "ğŸ“Š Deployment Status:"
      kubectl get deployments -n plugin
      echo ""
      echo "ğŸ¯ All 4 deployment methods tested successfully!"

  # Cleanup Block
  - block: "ğŸ§¹ Clean up test deployments?"
    key: "cleanup-block"
    depends_on: "verify-all"

  # Cleanup Step
  - label: "ğŸ§¹ Cleanup All Test Deployments"
    key: "cleanup-all"
    depends_on: "cleanup-block"
    agents:
      queue: kubernetes
    plugins:
      - kubernetes:
          podSpec:
            serviceAccountName: deployer-manager
            containers:
            - image: dtzar/helm-kubectl:latest
              name: helm-kubectl
    command: |
      echo "ğŸ§¹ Cleaning up test deployments..."
      helm uninstall k8s-plugin-nginx -n plugin || true
      helm uninstall docker-plugin-apache -n plugin || true
      helm uninstall compose-plugin-nginx -n plugin || true
      helm uninstall native-agent-busybox -n plugin || true
      echo "âœ… Cleanup complete!"
