steps:
  - label: ":docker: E2E Test - Build Multi-Platform Image with Namespace"
    agents:
      queue: kubernetes
      
    command: |
      set -euo pipefail
      
      echo "=== Step 1: Authenticate with Namespace using OIDC ==="
      
      # Request OIDC token from Buildkite
      echo "Requesting OIDC token with audience: federation.namespaceapis.com"
      OIDC_TOKEN=$$(buildkite-agent oidc request-token --audience federation.namespaceapis.com)
      echo "✓ OIDC token obtained from Buildkite"
      
      # Debug: Show token info (first 50 chars only for security)
      echo "Token preview: $${OIDC_TOKEN:0:50}..."
      
      # Exchange OIDC token for Namespace credentials
      echo "Exchanging token for workspace: tenant_uabmve166l99o"
      /root/.ns/bin/nsc auth exchange-oidc-token \
        --token "$$OIDC_TOKEN" \
        --tenant_id tenant_uabmve166l99o
      echo "✓ Authenticated with Namespace workspace"
      
      echo ""
      echo "=== Step 2: Configure Docker Buildx for Namespace ==="
      
      # Set up Namespace as a Docker Buildx builder
      /root/.ns/bin/nsc docker buildx setup --background --use
      echo "✓ Namespace remote builder configured"
      
      # Verify builder is available
      echo ""
      echo "Available builders:"
      docker buildx ls
      
      echo ""
      echo "=== Step 3: Build with Namespace Remote Builders ==="
      echo "Building: Dockerfile (helm-kubectl + AWS CLI)"
      echo "Platforms: linux/amd64, linux/arm64"
      echo "Registry: nscr.io/uabmve166l99o"
      echo ""
      
      # Build existing Dockerfile for both amd64 and arm64 using Namespace remote builders
      docker buildx build \
        --builder nsc-remote \
        --platform linux/amd64,linux/arm64 \
        -f Dockerfile \
        -t nscr.io/uabmve166l99o/helm-kubectl-aws:$${BUILDKITE_BUILD_NUMBER} \
        -t nscr.io/uabmve166l99o/helm-kubectl-aws:latest \
        --push \
        .
      
      echo ""
      echo "=== ✓ E2E Test Complete! ==="
      echo ""
      echo "✓ OIDC authentication successful"
      echo "✓ Namespace remote builders configured"
      echo "✓ Multi-platform build successful (amd64 + arm64)"
      echo "✓ Image pushed to Namespace registry"
      echo ""
      echo "Images available at:"
      echo "  • nscr.io/uabmve166l99o/helm-kubectl-aws:$${BUILDKITE_BUILD_NUMBER}"
      echo "  • nscr.io/uabmve166l99o/helm-kubectl-aws:latest"
      echo ""
      echo "View build details: https://cloud.namespace.so/workspace/builds"
